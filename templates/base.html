<!DOCTYPE HTML>
<html>
    <head>
        <title>{% block title %}{% endblock %}</title>
        <link rel="stylesheet" href="/static/styles.css"/>
        <link rel="icon" type="image/x-icon" href="/static/lsp_notes.png"/>
        <script src="/static/player.js"></script>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Page-specific head fields -->
        {% block head %}
        {% endblock %}
        <script>
            document.addEventListener("click", (event) => {
                // Handle all clicks on links
                if (!event.target.matches("a")) {
                    return;
                }

                var targetUrl = new URL(event.target.href);
                if (urlIsOnSameSite(targetUrl)) {
                    event.preventDefault();
                    fetch(targetUrl, {redirect: "follow", headers: {"Accept": "application/json"}}).then(handleAjaxResponse);
                }
            });
            document.addEventListener("DOMContentLoaded", (e) => {
                document.querySelectorAll("form").forEach((form) => {
                    console.log("found form");
                    form.addEventListener("submit", (event) => {
                        console.log("on submit");
                        var targetUrl = new URL(event.target.action);
                        if (urlIsOnSameSite(targetUrl)) {
                            event.preventDefault();
                            var formData = new FormData(event.target);
                            fetch(targetUrl, {redirect: "follow", body: formData, method: event.target.method, headers: {"Accept": "application/json"}})
                                .then(handleAjaxResponse);
                        }
                    });
                });
            });
            function urlIsOnSameSite(targetUrl) {
                var currentUrl = new URL(window.location.href);
                return targetUrl.origin === currentUrl.origin;
            }
            async function handleAjaxResponse(response) {
                // Update URL in browser window, minus request-type field
                var url = new URL(response.url);
                url.searchParams.delete("request-type");
                window.history.pushState({}, "", url);

                // Get page content from JSON response
                var data = await response.json();
                document.getElementById("main").innerHTML = data.body;
                document.title = data.title;

                // Trigger event to signal new page has loaded
                var event = new Event("DOMContentLoaded");
                document.dispatchEvent(event);

                // Refresh navbar in case logged-in status changed
                updateNavbar(data.username);
            }
            function updateNavbar(username) {
                var loggedIn = username ? true : false;
                document.querySelectorAll(".nav-logged-in").forEach((e) => {e.hidden = !loggedIn;});
                document.querySelectorAll(".nav-logged-out").forEach((e) => {e.hidden = loggedIn;});
                if (loggedIn) {
                    document.getElementById("logged-in-status").innerText = `Signed in as ${username}`;
                }
            }
        </script>
    </head>
    <body>

        <!-- Embedded image data -->
        {{ gif_data|safe }}

        <script>

            function customImage(element) {
                // Customize an image by performing a palette swap on the .gif
                // file.  The source element must contain a data-img-b64 attribute
                // containing the base64 representation of a .gif file.  The byte
                // indexes match .gifs from Aseprite, and may not work for all
                // .gif files.

                var style = window.getComputedStyle(document.body);
                var bgcolor = style.getPropertyValue("--yellow");
                var accolor = style.getPropertyValue("--purple");

                // Convert base64 string to Uint8Array so we can modify it
                var data = atob(element.dataset.imgB64);
                var bytes = Uint8Array.from(data, c => c.charCodeAt(0));

                // Replace background color palette bytes in gif file
                bytes[16] = parseInt(bgcolor.substring(1, 3), 16);
                bytes[17] = parseInt(bgcolor.substring(3, 5), 16);
                bytes[18] = parseInt(bgcolor.substring(5, 7), 16);

                // Replace foreground color palette bytes in gif file
                bytes[19] = parseInt(accolor.substring(1, 3), 16);
                bytes[20] = parseInt(accolor.substring(3, 5), 16);
                bytes[21] = parseInt(accolor.substring(5, 7), 16);

                // Convert Uint8Array back to base64 so we can use it in a src string
                data = btoa(String.fromCharCode(...bytes));

                // Embed base64 in a data string that can be used as an img src.
                return `data:image/gif;base64, ${data}`;
            }

            function updateImageColors() {
                // Perform a palette swap on all gifs based on current page colors

                document.querySelectorAll(".img-data").forEach(e => {
                    document.querySelectorAll(`.${e.id}`).forEach(t => {
                        t.src = customImage(e);
                    });
                });
            }

            // Update image colors on page load
            document.addEventListener("DOMContentLoaded", updateImageColors);

        </script>

        <div class="page-header">
            <div style="text-align: center;">
                <img class="title-image littlesongplace02">
            </div>
            <!-- Navbar -->
            <div class="navbar">
                <a href="/">Home</a>
                <a href="/site-news">News</a>

                <a href="/users/{{ session["username"] }}" class="nav-logged-in" hidden>My Profile</a>
                <a href="/activity"><span id="activity-indicator" hidden></span>Activity</a>
                <a href="/logout" class="nav-logged-in" hidden>Sign Out</a>

                <a href="/signup" class="nav-logged-out">Create Account</a>
                <a href="/login" class="nav-logged-out">Sign In</a>

                <span class="nav-logged-in" id="logged-in-status" hidden></span>
            </div>
        </div>

        {% if "username" in session %}
        <!-- Periodically update activity status indicator -->
        <script>
            updateNavbar("{{ session["username"] }}");

            async function checkForNewActivity() {
                const indicator = document.getElementById("activity-indicator")
                const response = await fetch("/new-activity");
                if (!response.ok) {
                    console.log(`Failed to get activity: ${response.status}`);
                }
                const json = await response.json();
                indicator.hidden = !json.new_activity;
            }

            // Check for new activity every 10s
            setInterval(checkForNewActivity, 10000);
            checkForNewActivity();  // Check immediately
        </script>
        {% endif %}

        <!-- Stite Status Messages -->
        {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
        <div class="flashes">
            <ul>
                {% for category, message in messages %}
                <li class="flash-msg {{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Page-Specific Content -->
        <div class="main" id="main">
        {% block body %}
        {% endblock %}
        </div>

        <!-- Padding to prevent player from obscuring content -->
        <div id="scroll-padding"></div>

        <!-- Song Player -->
        <div class="player-container" id="player-container">
            <div class="player" id="player" hidden>
                <div class="player-info">
                    <img id="player-pfp" class="small-pfp" src="" onerror="this.style.display = 'none'">
                    <span id="player-title">Not Playing</span>
                    <span id="player-info-sep" hidden>-</span>
                    <a id="player-artist" class="profile-link" hidden></a>
                    <span id="player-collabs"></span>
                </div>
                <div class="player-controls">
                    <button onclick="songPrevious()" class="player-button">
                        <img class="lsp_btn_prev02" alt="Previous">
                    </button>
                    <button onclick="songPlayPause()" class="player-button">
                        <img class="lsp_btn_pause02" alt="Play" id="play-pause-button">
                    </button>
                    <button onclick="songNext()" class="player-button">
                        <img class="lsp_btn_next02" alt="Next">
                    </button>
                    <input id="position-slider" name="song-position" type="range" min="0" max="1" step="any" value="0"/>
                    <span class="player-time" id="player-current-time">0:00</span>
                    <span class="player-time-sep">/</span>
                    <span class="player-time" id="player-total-time">0:00</span>
                    <audio id="player-audio"></audio>
                </div>
                <div class="player-volume desktop-only">
                    <label class="player-label" for="volume">Volume</label>
                    <input id="volume-slider" name="volume" type="range" min="0" max="1" step="any" value="1"/>
                </div>
            </div>
        </div>
    </body>
</html>

