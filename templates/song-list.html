<div class="song-list">
{% for song in songs %}
    <div class="song" data-song="{{ song.json() }}">
        <div class="song-main">
            <div class="song-info">
                <!-- Song Title -->
                <div class="song-title"><a href="/song/{{ song.userid }}/{{ song.songid }}?action=view">{{ song.title }}</a></div>

                <!-- Separator -->
                <div class="song-info-sep">
                    -
                </div>

                <!-- Song Artist -->
                <div class="song-artist">
                    <a href="/users/{{ song.username }}" class="profile-link">{{ song.username }}</a>

                <!-- Song Collaborators -->
                    {% for collab in song.collaborators %}
                        {% if collab.startswith("@") %}
                        <a href="/users/{{ collab[1:] }}" class="profile-link">{{ collab[1:] }}</a>
                        {% else %}
                        <span class="collab-name">{{ collab }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="song-buttons">

                <!-- Owner-Specific Buttons (Edit/Delete) -->
                {% if session["userid"] == song.userid %}
                <a href="/edit-song?songid={{ song.songid }}" class="song-list-button">
                    <img src="/static/lsp_btn_edit.gif" alt="Edit">
                </a>
                <a href="/delete-song/{{ song.songid }}" onclick="return confirm(&#34;Are you sure you want to delete this song?&#34;)" class="song-list-button">
                    <img src="/static/lsp_btn_delete.gif" alt="Delete">
                </a>
                {% endif %}

                <!-- Details Button -->
                <a href="#" onclick="return showDetails(event)" class="song-list-button">
                    <img src="/static/lsp_btn_show.gif" alt="Show Details">
                </a>

                <!-- Play Button -->
                <a href="#" onclick="return play(event)" class="song-list-button">
                    <img src="/static/lsp_btn_play.gif" alt="Play">
                </a>
            </div>
        </div>

        <div class="song-details" hidden>
            <!-- Song Description -->
            {% if song.description %}
            <div class="song-description">{{ song.description }}</div>
            {% endif %}

            <!-- Song Tags -->
            <div class="song-tags">
                Tags:
                {% for tag in song.tags %}
                <a href="/songs?user={{ song.username }}&tag={{ tag }}">{{ tag }}</a>
                {% endfor %}
            </div>

            <!-- Song Comments -->
            <div class="song-comments">
                Comments:<br>
                <a href="/comment?songid={{ song.songid }}">Add a Comment</a>

                {% for comment in song.get_comments() %}
                <div class="top-level-comment">

                    <a href="/users/{{ comment['username'] }}" class="profile-link">{{ comment['username'] }}</a>:
                    {{ comment['content'] }}

                    {% if session['userid'] == comment['userid'] or session['userid'] == song.userid %}
                    <div class="comment-button-container">
                    {% endif %}

                        <!-- Only commenter can edit comment -->
                        {% if session['userid'] == comment['userid'] %}
                        <a href="/comment?commentid={{ comment['commentid'] }}&songid={{ song.songid }}" class="comment-button">
                            Edit
                        </a>
                        {% endif %}

                        <!-- Commenter and song owner can delete comment -->
                        {% if session['userid'] == comment['userid'] or session['userid'] == song.userid %}
                        <a href="/delete-comment/{{ comment['commentid'] }}" onclick="return confirm(&#34;Are you sure you want to delete this comment?&#34;)" class="comment-button">
                            Delete
                        </a>
                        {% endif %}

                    {% if session['userid'] == comment['userid'] or session['userid'] == song.userid %}
                    </div>
                    {% endif %}

                    {% for reply in comment['replies'] %}
                    <div class="reply-comment">

                        <a href="/users/{{ reply['username'] }}" class="profile-link">{{ reply['username'] }}</a>:
                        {{ reply['content'] }}

                        {% if session['userid'] == reply['userid'] or session['userid'] == song.userid %}
                        <div class="comment-button-container">
                        {% endif %}

                            <!-- Only commenter can edit comment -->
                            {% if session['userid'] == reply['userid'] %}
                            <a href="/comment?commentid={{ reply['commentid'] }}&songid={{ song.songid }}&replytoid={{ comment['commentid'] }}" class="comment-button">
                                Edit
                            </a>
                            {% endif %}

                            <!-- Commenter and song owner can delete comment -->
                            {% if session['userid'] == reply['userid'] or session['userid'] == song.userid %}
                            <a href="/delete-comment/{{ reply['commentid'] }}" onclick="return confirm(&#34;Are you sure you want to delete this comment?&#34;)" class="comment-button">
                                Delete
                            </a>
                            {% endif %}

                        {% if session['userid'] == reply['userid'] or session['userid'] == song.userid %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <div class="comment-button-container">
                        <a href="/comment?songid={{ song.songid }}&replytoid={{ comment['commentid'] }}">Reply</a>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>
    </div>
{% endfor %}
</div>

<script>
function showDetails(event) {
    // Find song-main
    var songElement = event.target;
    while (!songElement.classList.contains("song"))
    {
        songElement = songElement.parentElement;
        console.log(songElement);
    }

    for (const child of songElement.children) {
        if (child.classList.contains("song-details")) {
            if (child.hidden) {
                // Show details
                child.hidden = false;
                event.target.alt = "Hide Details";
                event.target.src = "/static/lsp_btn_hide.gif";
            }
            else {
                // Hide details
                child.hidden = true;
                event.target.alt = "Show Details";
                event.target.src = "/static/lsp_btn_show.gif";
            }
        }
    }
    return false;
}
</script>
