{% macro song_artist(song) %}
<span class="song-artist">
    <a href="/users/{{ song.username }}" class="profile-link">{{ song.username }}</a>

    <!-- Song Collaborators -->
    {% for collab in song.collaborators %}
    {% if collab.startswith("@") -%}
    <a href="/users/{{ collab[1:] }}" class="profile-link">{{ collab[1:] }}</a>
    {%- else -%}
    <span class="collab-name">{{ collab }}</span>
    {%- endif %}
    {% endfor %}
</span>
{% endmacro %}

{% macro song_info(song) %}
<div class="song-info">
    <!-- Song Title -->
    <div class="song-title"><a href="/song/{{ song.userid }}/{{ song.songid }}?action=view">{{ song.title }}</a></div>

    <!-- Separator -->
    <div class="song-info-sep">
        -
    </div>

    <!-- Song Artist(s) -->
    {{ song_artist(song) | indent(4) }}
</div>
{% endmacro %}

{% macro song_details(song, current_user_playlists, hidden=True) %}
<div class="song-details" {% if hidden %}hidden{% endif %}>
    {% if current_user_playlists -%}
    <!-- Add to Playlist Buttons -->
    <div class="song-playlist-controls">
        <form action="/append-to-playlist" method="post">
            <input type="hidden" name="songid" value="{{ song.songid }}" id="playlist-selector-songid"/>
            <select name="playlistid" onchange="this.closest('form').requestSubmit()">
                <option value="-1">Add to Playlist...</option>
                {% for plist in current_user_playlists -%}
                <option value="{{ plist.playlistid }}">{{ plist['name'] }}</option>
                {%- endfor %}
            </select>
        </form>
    </div>
    {%- endif %}

    {% if song.description -%}
    <!-- Song Description -->
    <div class="song-description">{{ (song.description.replace("\n", "<br>"))|safe  }}</div>
    {%- endif %}

    {% if song.tags -%}
    <!-- Song Tags -->
    <div class="song-tags">
        Tags:
        {% for tag in song.tags %}
        <a href="/songs?user={{ song.username }}&tag={{ tag }}">{{ tag }}</a>
        {% endfor %}
    </div>
    {%- endif %}

    <div class="song-date">
        Uploaded {{ song.created }}
    </div>

    <!-- Song Comments -->
    <div class="song-comments">
        Comments:<br>
        {% if session['userid'] %}
        <a href="/comment?songid={{ song.songid }}" class="song-list-button" title="Add a Comment"><img class="lsp_btn_add02" /></a>
        {% endif %}

        {% for comment in song.get_comments() %}
        <div class="top-level-comment">

            <a href="/users/{{ comment['username'] }}" class="profile-link">{{ comment['username'] }}</a>:
            {{ (comment['content'].replace("\n", "<br>"))|safe }}

            {% if session['userid'] == comment['userid'] or session['userid'] == song.userid %}
            <div class="comment-button-container">
            {% endif %}

                <!-- Only commenter can edit comment -->
                {% if session['userid'] == comment['userid'] %}
                <a href="/comment?commentid={{ comment['commentid'] }}&songid={{ song.songid }}" class="song-list-button" title="Edit">
                    <img class="lsp_btn_edit02" />
                </a>
                {% endif %}

                <!-- Commenter and song owner can delete comment -->
                {% if session['userid'] == comment['userid'] or session['userid'] == song.userid %}
                <a href="/delete-comment/{{ comment['commentid'] }}" onclick="return confirm(&#34;Are you sure you want to delete this comment?&#34;)" class="song-list-button" title="Delete">
                    <img class="lsp_btn_delete02" />
                </a>
                {% endif %}

            {% if session['userid'] == comment['userid'] or session['userid'] == song.userid %}
            </div>
            {% endif %}

            {% for reply in comment['replies'] %}
            <div class="reply-comment">

                <a href="/users/{{ reply['username'] }}" class="profile-link">{{ reply['username'] }}</a>:
                {{ reply['content'] }}

                {% if session['userid'] == reply['userid'] or session['userid'] == song.userid %}
                <div class="comment-button-container">
                {% endif %}

                    <!-- Only commenter can edit comment -->
                    {% if session['userid'] == reply['userid'] %}
                    <a href="/comment?commentid={{ reply['commentid'] }}&songid={{ song.songid }}&replytoid={{ comment['commentid'] }}" class="song-list-button" title="Edit">
                        <img class="lsp_btn_edit02" />
                    </a>
                    {% endif %}

                    <!-- Commenter and song owner can delete comment -->
                    {% if session['userid'] == reply['userid'] or session['userid'] == song.userid %}
                    <a href="/delete-comment/{{ reply['commentid'] }}" onclick="return confirm(&#34;Are you sure you want to delete this comment?&#34;)" class="song-list-button" title="delete">
                        <img class="lsp_btn_delete02" />
                    </a>
                    {% endif %}

                {% if session['userid'] == reply['userid'] or session['userid'] == song.userid %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <div class="comment-button-container">
                <a href="/comment?songid={{ song.songid }}&replytoid={{ comment['commentid'] }}">Reply</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endmacro %}
